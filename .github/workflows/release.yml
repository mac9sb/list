name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    uses: mac9sb/server/.github/workflows/project-release.yml@main
    permissions:
      contents: write
    with:
      tag_name: ${{ github.ref_name }}
      release_title_prefix: Release
      draft: false
      generate_release_notes: false
      release_body_intro: Swift CLI binaries for macOS and Linux.

      build_enabled: true
      build_matrix: |
        [
          {
            "runner": "macos-14",
            "swift_version": "6.2",
            "artifact_name": "sls-macos-x86_64",
            "artifact_path": "release/sls-macos-x86_64",
            "build_command": "swift build -c release --arch x86_64\nmkdir -p release\ncp .build/release/sls release/sls-macos-x86_64"
          },
          {
            "runner": "macos-14",
            "swift_version": "6.2",
            "artifact_name": "sls-macos-aarch64",
            "artifact_path": "release/sls-macos-aarch64",
            "build_command": "swift build -c release --arch arm64\nmkdir -p release\ncp .build/release/sls release/sls-macos-aarch64"
          },
          {
            "runner": "ubuntu-22.04",
            "artifact_name": "sls-linux-x86_64",
            "artifact_path": "release/sls-linux-x86_64",
            "build_command": "curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz\ntar zxf swiftly-$(uname -m).tar.gz\n./swiftly init --quiet-shell-followup\n. \"${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh\"\nhash -r\nswiftly install 6.2\nswift build -c release\nmkdir -p release\ncp .build/release/sls release/sls-linux-x86_64"
          },
          {
            "runner": "ubuntu-22.04-arm",
            "artifact_name": "sls-linux-aarch64",
            "artifact_path": "release/sls-linux-aarch64",
            "build_command": "curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz\ntar zxf swiftly-$(uname -m).tar.gz\n./swiftly init --quiet-shell-followup\n. \"${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh\"\nhash -r\nswiftly install 6.2\nswift build -c release\nmkdir -p release\ncp .build/release/sls release/sls-linux-aarch64"
          }
        ]
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
